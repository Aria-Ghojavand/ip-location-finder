stages:
  - build
  - push
  - deploy

variables:
  ARIA_REGISTRY: "registry-17250252bc-aria.apps.ir-central1.arvancaas.ir"
  ARIA_IMAGE: "$ARIA_REGISTRY/go-app"
  ARIA_USER: "aria"
  ARIA_PASSWORD: "12345678"
  TAG: "$CI_COMMIT_SHORT_SHA"

# ----------------------------
# 1. Build Docker image
# ----------------------------
build-image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    GOPROXY: "direct"
    GOSUMDB: "off"
    GOMODCACHE: "$CI_PROJECT_DIR/.gocache"
    DOCKER_CLIENT_TIMEOUT: "300"
    COMPOSE_HTTP_TIMEOUT: "300"
    DOCKER_BUILD_TIMEOUT: "1800"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gocache/
    policy: pull-push
    when: on_success
  script:
    - docker build -t $ARIA_IMAGE:$TAG .
    - docker tag $ARIA_IMAGE:$TAG $ARIA_IMAGE:latest
  artifacts:
    paths:
      - image.tar
    expire_in: 1h
  only:
    - main
    - staging

# ----------------------------
# 2. Push image to Aria registry
# ----------------------------
push-image:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    GOPROXY: "https://proxy.golang.org,direct"
    GOSUMDB: "sum.golang.org"
    GOMODCACHE: "$CI_PROJECT_DIR/.gocache"
    DOCKER_CLIENT_TIMEOUT: "600"
    COMPOSE_HTTP_TIMEOUT: "600"
    DOCKER_PUSH_TIMEOUT: "1800"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gocache/
    policy: pull
    when: on_success
  before_script:
    - echo "nameserver 8.8.8.8" >> /etc/resolv.conf
    - echo "nameserver 1.1.1.1" >> /etc/resolv.conf
    - |
      for i in {1..5}; do
        echo "Attempt $i: Trying to login to Aria registry..."
        if echo $ARIA_PASSWORD | timeout 120 docker login -u $ARIA_USER $ARIA_REGISTRY --password-stdin; then
          echo "Successfully logged in to Aria registry"
          break
        else
          echo "Login attempt $i failed, retrying in 15 seconds..."
          sleep 15
        fi
        if [ $i -eq 5 ]; then
          echo "All login attempts failed"
          exit 1
        fi
      done
    - |
      echo "Testing connection to Aria registry..."
      curl -I --connect-timeout 30 --max-time 60 https://$ARIA_REGISTRY/v2/ || echo "Registry connection test failed, but continuing..."
  script:
    - |
      if ! docker images | grep -q "$ARIA_IMAGE:$TAG"; then
        echo "Image not found, rebuilding..."
        for i in {1..3}; do
          echo "Attempt $i: Building Docker image..."
          if timeout 1800 docker build -t $ARIA_IMAGE:$TAG .; then
            echo "Successfully built image"
            docker tag $ARIA_IMAGE:$TAG $ARIA_IMAGE:latest
            break
          else
            echo "Build attempt $i failed, retrying in 10 seconds..."
            sleep 10
          fi
          if [ $i -eq 3 ]; then
            echo "All build attempts failed"
            exit 1
          fi
        done
      fi
    - |
      for i in {1..5}; do
        echo "Attempt $i: Pushing Docker image $ARIA_IMAGE:$TAG..."
        if timeout 1800 docker push $ARIA_IMAGE:$TAG; then
          echo "Successfully pushed $ARIA_IMAGE:$TAG"
          break
        else
          echo "Push attempt $i failed, retrying in 30 seconds..."
          sleep 30
          # Re-login before retry
          if [ $i -lt 5 ]; then
            echo "Re-logging into Aria registry before retry..."
            echo $ARIA_PASSWORD | timeout 120 docker login -u $ARIA_USER $ARIA_REGISTRY --password-stdin
          fi
        fi
        if [ $i -eq 5 ]; then
          echo "All push attempts failed for $ARIA_IMAGE:$TAG"
          exit 1
        fi
      done
    - |
      for i in {1..5}; do
        echo "Attempt $i: Pushing Docker image $ARIA_IMAGE:latest..."
        if timeout 1800 docker push $ARIA_IMAGE:latest; then
          echo "Successfully pushed $ARIA_IMAGE:latest"
          break
        else
          echo "Push attempt $i failed, retrying in 30 seconds..."
          sleep 30
          # Re-login before retry
          if [ $i -lt 5 ]; then
            echo "Re-logging into Aria registry before retry..."
            echo $ARIA_PASSWORD | timeout 120 docker login -u $ARIA_USER $ARIA_REGISTRY --password-stdin
          fi
        fi
        if [ $i -eq 5 ]; then
          echo "All push attempts failed for $ARIA_IMAGE:latest"
          exit 1
        fi
      done
  only:
    - main
    - staging

# ----------------------------
# 3. Deploy to Kubernetes
# ----------------------------
deploy-k8s:
  stage: deploy
  image: alpine:3.18
  variables:
    GOPROXY: "https://proxy.golang.org,direct"
    GOSUMDB: "sum.golang.org"
    GOMODCACHE: "$CI_PROJECT_DIR/.gocache"
    KUBECTL_VERSION: "v1.28.3"
  before_script:
    - apk add --no-cache curl ca-certificates
    - curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
    - chmod +x kubectl
    - mv kubectl /usr/local/bin/
    - mkdir -p ~/.kube
    - |
      if echo "$KUBECONFIG_DATA" | base64 -d > ~/.kube/config 2>/dev/null; then
        echo "Successfully decoded base64 kubeconfig"
      else
        echo "Using kubeconfig as plain text"
        echo "$KUBECONFIG_DATA" > ~/.kube/config
      fi
    - chmod 600 ~/.kube/config
    - echo "Kubeconfig format check:"
    - head -n 5 ~/.kube/config
    - kubectl version --client
    - kubectl cluster-info || echo "Cluster info failed, but continuing..."
  script:
    - kubectl set image -f k8s/go-app-statefulset.yaml go-app=$ARIA_IMAGE:$TAG --local -o yaml | kubectl apply -f -
    - kubectl apply -f k8s/
    - kubectl rollout status statefulset go-app --timeout=300s
  environment:
    name: production
    url: https://app.titimod.ir
  only:
    - main